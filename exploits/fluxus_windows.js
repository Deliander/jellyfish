
if (process.platform != "win32") return require("./null");



const { dialog } = require('electron')
const fs = require("fs")
const path = require("path")
const child_process = require('child_process')
const fetch = require("node-fetch")
const net = require("net")

JELLYFISH_DATA_DIR = global.JELLYFISH_DATA_DIR


function init() {}

function downloadInitialScripts() {}



function runScript(arg) {
    try {
        var c = net.connect("\\\\.\\pipe\\WeAreDevsPublicAPI_Lua",() => {
            c.end(arg)
            win.webContents.send("script-ran")
        })
    } catch(e) {}
}

var firstInject = true



async function update() {
    var vf = await fetch("https://cdn.wearedevs.net/software/exploitapi/latestdata.txt")
    var vv = (await vf.text()).split(" ")
    var updated = vv[0]
    if (updated != "true") return false
    var df = await fetch(vv[1])
    var ws = fs.createWriteStream(path.join(JELLYFISH_DATA_DIR,"wrd_exploit.dll"))
    df.body.pipe(ws)    
    return new Promise((a,r)=>{df.body.on("end",()=>{ws.end();a(true)})})
}

async function checkCreds(event,arg) {
    event.reply("login-success")
    setTimeout(function() {
        event.reply("enable-inject-btn")
    },2000)
    return true
}

async function inject(event,arg) {
    var win = global.win
    event.reply("set-inject-btn-text","Updating")
    var updated = await update()
    if (!updated) {
        dialog.showMessageBoxSync(win,{
            message: "WRD isn't updated.",
            detail: "Please wait for WRD to update it!",
        })
        event.reply("set-inject-btn-text","Not updated")
        return setTimeout(function() {
            event.reply("enable-inject-btn")
        },2000)
    }
    event.reply("set-inject-btn-text","Injecting")
    var out = child_process.execFileSync(path.resolve("JellyInjector-GenericPipe.exe"),["?",path.join(JELLYFISH_DATA_DIR,"wrd_exploit.dll")])
    out = out.toString()
    console.log(out)
    if (dialog.showMessageBoxSync(win,{
        message: "WRD injected.",
        detail: "Enjoying Jellyfish? Consider donating for more updates and features.",
        buttons: ["Sure","Dismiss"],
        defaultId: 1,
    }) != 1) {
        child_process.spawnSync("cmd",["/s","/c","start","https://thelmgn.com/donate.html","/b"])
    }
    event.reply("set-inject-btn-text","Injected")
    return setTimeout(function() {
        event.reply("enable-inject-btn")
    },2000)

}

module.exports = {init,downloadInitialScripts,checkCreds,inject,runScript}